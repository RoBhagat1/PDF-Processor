<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Upload PDF</title>
    <style>
      body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:40px;max-width:1200px}
      label{display:block;margin-bottom:8px;font-weight:600}
      input[type=file]{margin-bottom:12px}
      input[type=number],input[type=text],select{padding:8px;margin-bottom:12px;border:1px solid #ccc;border-radius:4px;width:200px}
      button{padding:10px 20px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer}
      button:hover{background:#0056b3}
      hr{margin:40px 0}
      .section{background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px}
      .discrepancy-card{background:white;padding:15px;margin:10px 0;border-left:4px solid #dc3545;border-radius:4px}
      .no-discrepancy{border-left-color:#28a745}
      .severity-high{color:#dc3545;font-weight:bold}
      .severity-medium{color:#fd7e14;font-weight:bold}
      .severity-low{color:#ffc107;font-weight:bold}
      .badge{display:inline-block;padding:4px 8px;border-radius:3px;font-size:0.85em;margin:2px}
      .badge-high{background:#dc3545;color:white}
      .badge-medium{background:#fd7e14;color:white}
      .badge-low{background:#ffc107;color:#333}
      .config-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin:15px 0}
    </style>
  </head>
  <body>
    <h1>Upload a PDF</h1>
    <form id="uploadForm">
      <label for="pdf">Select PDF file</label>
      <input id="pdf" name="pdf" type="file" accept="application/pdf" />
      <br />
      <button type="submit">Upload</button>
    </form>
    <hr />
    <h2>Bulk upload a folder of PDFs</h2>
    <p>Choose a folder (Chrome/Safari support via <code>webkitdirectory</code>)</p>
    <input id="folderInput" type="file" webkitdirectory directory multiple />
    <br />
    <button id="bulkUploadBtn">Upload Folder PDFs</button>
    <button id="processFolderBtn">Process PDFs Folder</button>
    <div id="bulkStatus"></div>
    <div id="status"></div>

    <hr />
    <div class="section">
      <h2>Invoice Discrepancy Detection</h2>
      <p>Upload an invoice PDF to check for discrepancies against historical data</p>

      <form id="invoiceForm">
        <label for="invoicePdf">Select Invoice PDF</label>
        <input id="invoicePdf" name="pdf" type="file" accept="application/pdf" />
        <br />

        <h3>Detection Settings</h3>
        <div class="config-group">
          <div>
            <label for="percentageThreshold">Percentage Threshold (%)</label>
            <input type="number" id="percentageThreshold" value="15" min="0" max="100" step="1" />
          </div>
          <div>
            <label for="stdDevThreshold">Standard Deviation (σ)</label>
            <input type="number" id="stdDevThreshold" value="2" min="0" max="5" step="0.5" />
          </div>
          <div>
            <label for="detectionMode">Detection Mode</label>
            <select id="detectionMode">
              <option value="both">Both (Percentage & StdDev)</option>
              <option value="percentage">Percentage Only</option>
              <option value="stddev">Standard Deviation Only</option>
            </select>
          </div>
          <div>
            <label for="minSamples">Minimum Samples</label>
            <input type="number" id="minSamples" value="3" min="1" max="20" step="1" />
          </div>
        </div>
        <br />
        <button type="submit">Process Invoice</button>
      </form>

      <div id="invoiceStatus" style="margin-top:15px;font-weight:600"></div>
      <div id="discrepancyResults" style="margin-top:20px"></div>
    </div>

    <hr />
    <div class="section">
      <div id="stats">Loading statistics...</div>
    </div>

    <script>
      const form = document.getElementById('uploadForm');
      const status = document.getElementById('status');
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
    const input = document.getElementById('pdf');
        if (!input.files.length) return status.textContent = 'No file selected';
        const file = input.files[0];
        const fd = new FormData();
        fd.append('pdf', file);
        status.textContent = 'Uploading...';
        try {
          const res = await fetch('/upload', { method: 'POST', body: fd });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || 'Upload failed');
          status.textContent = 'Uploaded: ' + data.file;
        } catch (err) {
          status.textContent = 'Error: ' + err.message;
        }
      });

      // Bulk folder upload
      const folderInput = document.getElementById('folderInput');
      const bulkUploadBtn = document.getElementById('bulkUploadBtn');
      const processFolderBtn = document.getElementById('processFolderBtn');
      const bulkStatus = document.getElementById('bulkStatus');

      bulkUploadBtn.addEventListener('click', async () => {
        const files = Array.from(folderInput.files || []).filter(f => f.name.toLowerCase().endsWith('.pdf'));
        if (!files.length) return bulkStatus.textContent = 'No PDF files found in selected folder.';
        bulkStatus.textContent = `Uploading ${files.length} PDFs...`;
        let completed = 0;
        for (const f of files) {
          const fd = new FormData();
          fd.append('pdf', f, f.name);
          try {
            const res = await fetch('/upload', { method: 'POST', body: fd });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'Upload failed');
            completed++;
            bulkStatus.textContent = `Uploaded ${completed}/${files.length}: ${f.name}`;
          } catch (err) {
            bulkStatus.textContent = `Error uploading ${f.name}: ${err.message}`;
            console.error(err);
          }
        }
        bulkStatus.textContent = `Upload complete: ${completed}/${files.length} files uploaded.`;
      });

      processFolderBtn.addEventListener('click', async () => {
        bulkStatus.textContent = 'Processing server-side folder...';
        try {
          const res = await fetch('/process-folder', { method: 'POST' });
          const data = await res.json();
          bulkStatus.textContent = `Processing complete. Results: ${JSON.stringify(data.results)}`;
        } catch (err) {
          bulkStatus.textContent = 'Processing failed: ' + err.message;
        }
      });

      // Invoice discrepancy detection
      const invoiceForm = document.getElementById('invoiceForm');
      const invoiceStatus = document.getElementById('invoiceStatus');
      const discrepancyResults = document.getElementById('discrepancyResults');
      const statsDiv = document.getElementById('stats');

      invoiceForm.addEventListener('submit', async (ev) => {
        ev.preventDefault();

        const input = document.getElementById('invoicePdf');
        if (!input.files.length) {
          invoiceStatus.textContent = 'No file selected';
          return;
        }

        const file = input.files[0];
        const fd = new FormData();
        fd.append('pdf', file);
        fd.append('percentageThreshold', document.getElementById('percentageThreshold').value / 100);
        fd.append('stdDevThreshold', document.getElementById('stdDevThreshold').value);
        fd.append('mode', document.getElementById('detectionMode').value);
        fd.append('minSamples', document.getElementById('minSamples').value);

        invoiceStatus.textContent = 'Processing invoice...';
        discrepancyResults.innerHTML = '';

        try {
          const res = await fetch('/process-invoice', { method: 'POST', body: fd });
          const data = await res.json();

          if (!res.ok) throw new Error(data.error || 'Processing failed');

          invoiceStatus.textContent = 'Processing complete!';

          const report = data.report;
          const filename = file.name.replace(/\.pdf$/i, '');

          let html = '<div class="section">';
          html += '<h3>Invoice Details</h3>';
          html += `<p><strong>Invoice #:</strong> ${report.invoice.invoiceNumber || 'Unknown'}</p>`;
          html += `<p><strong>Vendor:</strong> ${report.invoice.vendor || 'Unknown'}</p>`;
          html += `<p><strong>Date:</strong> ${report.invoice.invoiceDate || 'Unknown'}</p>`;
          html += `<p><strong>Total:</strong> $${report.invoice.total?.toFixed(2) || '0.00'}</p>`;
          html += '</div>';

          html += '<div class="section ' + (report.summary.hasDiscrepancies ? '' : 'no-discrepancy') + '">';
          html += '<h3>Summary</h3>';
          html += `<p style="font-size:1.2em"><strong>${report.summary.hasDiscrepancies ? '⚠ DISCREPANCIES FOUND' : '✓ NO DISCREPANCIES'}</strong></p>`;
          html += `<p><strong>Total Discrepancies:</strong> ${report.summary.totalCount}</p>`;

          if (report.summary.hasDiscrepancies) {
            html += '<div>';
            html += `<span class="badge badge-high">High: ${report.summary.severityBreakdown.high}</span>`;
            html += `<span class="badge badge-medium">Medium: ${report.summary.severityBreakdown.medium}</span>`;
            html += `<span class="badge badge-low">Low: ${report.summary.severityBreakdown.low}</span>`;
            html += '</div>';

            html += '<h4 style="margin-top:20px">Discrepancy Details:</h4>';
            report.discrepancies.forEach((d, i) => {
              html += `<div class="discrepancy-card">`;
              html += `<p><strong>#${i + 1}: ${d.description || d.field.toUpperCase()}</strong></p>`;
              html += `<p><strong>Field:</strong> ${d.field}</p>`;
              html += `<p><strong>Current Value:</strong> ${d.currentValue}</p>`;
              html += `<p><strong>Historical Average:</strong> ${d.historicalAverage.toFixed(2)}</p>`;
              html += `<p><strong>Variance:</strong> <span class="severity-${d.severity}">${(d.percentageVariance * 100).toFixed(1)}%</span></p>`;
              html += `<p><strong>Severity:</strong> <span class="badge badge-${d.severity}">${d.severity.toUpperCase()}</span></p>`;
              html += `<p><small>Based on ${d.historicalCount} historical samples</small></p>`;
              html += '</div>';
            });

            html += `<p style="margin-top:20px"><a href="/report/${filename}" target="_blank" style="color:#007bff">View Full HTML Report</a> | `;
            html += `<a href="/report/${filename}/text" target="_blank" style="color:#007bff">View Text Report</a></p>`;
          }

          html += '</div>';
          discrepancyResults.innerHTML = html;

          // Refresh statistics
          loadStatistics();
        } catch (err) {
          invoiceStatus.textContent = 'Error: ' + err.message;
        }
      });

      // Load and display statistics
      async function loadStatistics() {
        try {
          const res = await fetch('/statistics');
          const data = await res.json();

          let html = '<h4>Current Statistics</h4>';
          html += `<p><strong>Total Invoices Processed:</strong> ${data.invoiceCount}</p>`;
          html += `<p><strong>Unique Items Tracked:</strong> ${data.itemCount}</p>`;
          html += `<p><strong>Vendors Tracked:</strong> ${data.vendorCount}</p>`;
          html += `<p><small>Last Updated: ${data.lastUpdated ? new Date(data.lastUpdated).toLocaleString() : 'Never'}</small></p>`;

          statsDiv.innerHTML = html;
        } catch (err) {
          statsDiv.innerHTML = '<p>Unable to load statistics</p>';
        }
      }

      // Load statistics on page load
      loadStatistics();
    </script>
  </body>
</html>
